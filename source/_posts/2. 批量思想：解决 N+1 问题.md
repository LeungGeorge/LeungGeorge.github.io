---
tags:
  - 性能优化
  - 总结
  - blog
share: "true"
categories:
  - 系统优化
title: 批量思想：解决 N+1 问题
date: 2024-08-06,16:25
comments: true
---

## 批量思想：解决 `N+1` 问题

`N+1` 查询问题指的是当查询一个对象的列表数据的时候，会首先查询列表中的对象的 `ID`，然后循环生成单独的 `SQL/RPC` 去查询对象的详细数据。这会导致 `SQL/RPC` 查询过多问题。

**业务场景：**

在业务初期下游没有批量的接口，同时单次需要查询的记录很少（最多可能就两三个）。于是，在一个循环内多次调用。美滋滋，五分钟搞定，问题不大能跑起来了。
随着业务的发展，查询 id 越来越多（甚至有几十个），接口耗时部题可想而知，长尾越来越多 `^_^`

> 得益于采用 [1. 防御式设计：参数检查](1%20Project/腾讯/智影/浅析服务端优化/智影：浅析后端接口优化实战（20240331）/1.%20防御式设计：参数检查.md) 限制了 id 的最大个数，使得情况不至于糟糕到不可控。
> 所以，参数检查有大用。

**案例 1：**

读取多条记录时在 `for` 循环中去分别读取单行。

```go
for _, id := range ids {
    record := GetDetail(id)
    // do something ...
}
```

**解决方案：改批量（一次从存储中取出所有 id 的结果）**

```go
records := GetDetails(ids)
// do something ...
```

**谚云：积羽沉舟，群轻折轴**

上述场景是一个典型的 `N+1` 问题，不限于读取，写入亦然。它可能导致性能问题和增加数据库负载。

为了解决 `N+1` 问题，开发人员可以使用一些技术，如批量加载（batch loading)、批量更新（Bulk Updates），从而减少请求次数。通过优化数据库查询和加载策略，开发人员可以避免 `N+1` 问题，并提高应用程序的效率。
